<!DOCTYPE html>
<html>
<head>
    <title>NORDSAGA - –ò–≥—Ä–∞</title>
    <style>
        body {
            background: #0a0c10;
            color: #ffd700;
            font-family: Arial;
            padding: 20px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            background: #1a1e26;
            padding: 20px;
            border: 2px solid #b8860b;
            margin-bottom: 20px;
            text-align: center;
        }
        .map {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 5px;
            background: #1a1e26;
            padding: 20px;
            border: 2px solid #b8860b;
            margin-bottom: 20px;
        }
        .cell {
            aspect-ratio: 1;
            background: #2a2f3a;
            border: 1px solid #b8860b;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            cursor: pointer;
        }
        .cell.player {
            background: #ffd700;
            color: #000;
        }
        .buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        button {
            background: #1a1e26;
            border: 2px solid #b8860b;
            color: #ffd700;
            padding: 15px;
            cursor: pointer;
            font-size: 1.1rem;
        }
        button:hover {
            background: #b8860b;
            color: #000;
        }
        .log {
            background: #1a1e26;
            padding: 20px;
            border: 2px solid #b8860b;
            height: 150px;
            overflow-y: auto;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <h1>‚öîÔ∏è NORDSAGA ‚öîÔ∏è</h1>
    <p>–Ø—Ä–ª: <%= user.username %></p>
    
    <div class="stats" id="stats">
        <div>üëë –°–ª–∞–≤–∞: <span id="glory">0</span></div>
        <div>üí∞ –ó–æ–ª–æ—Ç–æ: <span id="gold">0</span></div>
        <div>üõ°Ô∏è –î—Ä—É–∂–∏–Ω–∞: <span id="crew">0</span></div>
        <div>‚öîÔ∏è –°–∏–ª–∞: <span id="power">0</span></div>
        <div>üçñ –ï–¥–∞: <span id="food">0</span></div>
        <div>üìÖ –î–µ–Ω—å: <span id="day">0</span></div>
    </div>
    
    <div class="map" id="map"></div>
    
    <div class="buttons">
        <button onclick="move('north')">‚¨ÜÔ∏è –°–ï–í–ï–†</button>
        <button onclick="move('south')">‚¨áÔ∏è –Æ–ì</button>
        <button onclick="move('west')">‚¨ÖÔ∏è –ó–ê–ü–ê–î</button>
        <button onclick="move('east')">‚û°Ô∏è –í–û–°–¢–û–ö</button>
        <button onclick="rest()">üèïÔ∏è –û–¢–î–´–•</button>
        <button onclick="hunt()">üèπ –û–•–û–¢–ê</button>
        <button onclick="trade()">üí∞ –¢–û–†–ì–û–í–õ–Ø</button>
        <button onclick="saveGame()">üíæ –°–û–•–†–ê–ù–ò–¢–¨</button>
    </div>
    
    <div class="log" id="log"></div>

    <script>
        let player = {
            x: 2, y: 2,
            glory: 100,
            gold: 200,
            crew: 50,
            power: 100,
            food: 30,
            day: 1,
            inventory: { wood: 10, iron: 5, weapons: 3, treasure: 0 }
        };
        
        let map = [
            ['üè∞', 'üå≤', '‚õ∞Ô∏è', 'üåä', 'üè°'],
            ['üå≤', 'üè°', 'üå≤', '‚õ∞Ô∏è', 'üåä'],
            ['üåä', 'üå≤', 'üè°', 'üå≤', '‚õ∞Ô∏è'],
            ['‚õ∞Ô∏è', 'üåä', 'üå≤', 'üè∞', 'üå≤'],
            ['üè°', '‚õ∞Ô∏è', 'üåä', 'üå≤', 'üè∞']
        ];
        
        let visited = {'2,2': true};

        async function loadGame() {
            try {
                const res = await fetch('/api/load');
                const data = await res.json();
                if (data.game) {
                    player = data.game;
                    updateAll();
                    addLog('–ò–≥—Ä–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
                }
            } catch (e) {
                addLog('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
            }
        }

        async function saveGame() {
            try {
                await fetch('/api/save', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ gameData: player })
                });
                addLog('–ò–≥—Ä–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞');
            } catch (e) {
                addLog('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
            }
        }

        function updateStats() {
            document.getElementById('glory').innerHTML = player.glory;
            document.getElementById('gold').innerHTML = player.gold;
            document.getElementById('crew').innerHTML = player.crew;
            document.getElementById('power').innerHTML = player.power;
            document.getElementById('food').innerHTML = player.food;
            document.getElementById('day').innerHTML = player.day;
        }

        function renderMap() {
            let html = '';
            for (let y = 0; y < 5; y++) {
                for (let x = 0; x < 5; x++) {
                    let classes = 'cell';
                    if (x === player.x && y === player.y) classes += ' player';
                    html += `<div class="${classes}" onclick="moveTo(${x},${y})">${map[y][x]}</div>`;
                }
            }
            document.getElementById('map').innerHTML = html;
        }

        function addLog(text) {
            const log = document.getElementById('log');
            log.innerHTML += `<div>‚öîÔ∏è ${text}</div>`;
            log.scrollTop = log.scrollHeight;
        }

        function move(dir) {
            let newX = player.x, newY = player.y;
            if (dir === 'north' && player.y > 0) newY--;
            if (dir === 'south' && player.y < 4) newY++;
            if (dir === 'west' && player.x > 0) newX--;
            if (dir === 'east' && player.x < 4) newX++;
            
            if (newX !== player.x || newY !== player.y) {
                player.x = newX;
                player.y = newY;
                player.food -= 5;
                player.day++;
                visited[`${player.x},${player.y}`] = true;
                
                if (player.food < 0) {
                    player.crew -= 5;
                    player.food = 0;
                    addLog('–ì–æ–ª–æ–¥! –ü–æ—Ç–µ—Ä–∏ –≤ –¥—Ä—É–∂–∏–Ω–µ');
                }
                
                locationEvent();
                updateAll();
            }
        }

        function moveTo(x, y) {
            if (x !== player.x || y !== player.y) {
                player.x = x;
                player.y = y;
                player.food -= 5;
                player.day++;
                locationEvent();
                updateAll();
            }
        }

        function locationEvent() {
            let cell = map[player.y][player.x];
            let event = '';
            
            if (cell === 'üè°' || cell === 'üè∞') {
                let r = Math.random();
                if (r < 0.3) {
                    player.gold += 50;
                    event = '–ù–∞—à–ª–∏ –∑–æ–ª–æ—Ç–æ! +50';
                } else if (r < 0.6) {
                    player.crew += 5;
                    event = '–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –≤–æ–∏–Ω—ã! +5';
                } else {
                    player.power += 10;
                    event = '–£–ª—É—á—à–∏–ª–∏ –æ—Ä—É–∂–∏–µ! +10 —Å–∏–ª—ã';
                }
            } else if (cell === 'üå≤') {
                let r = Math.random();
                if (r < 0.4) {
                    player.food += 20;
                    event = '–£–¥–∞—á–Ω–∞—è –æ—Ö–æ—Ç–∞! +20 –µ–¥—ã';
                } else if (r < 0.7) {
                    player.crew -= 3;
                    event = '–ù–∞–ø–∞–ª–∏ –≤–æ–ª–∫–∏! -3 –¥—Ä—É–∂–∏–Ω—ã';
                }
            } else if (cell === '‚õ∞Ô∏è') {
                let r = Math.random();
                if (r < 0.3) {
                    player.gold += 100;
                    player.inventory.treasure++;
                    event = '–ù–∞—à–ª–∏ —Å–æ–∫—Ä–æ–≤–∏—â–∞! +100 –∑–æ–ª–æ—Ç–∞';
                } else if (r < 0.6) {
                    player.crew -= 5;
                    event = '–ö–∞–º–Ω–µ–ø–∞–¥! -5 –¥—Ä—É–∂–∏–Ω—ã';
                }
            } else if (cell === 'üåä') {
                let r = Math.random();
                if (r < 0.3) {
                    player.gold += 30;
                    event = '–ù–∞—à–ª–∏ –∑–∞—Ç–æ–Ω—É–≤—à–∏–π –∫–æ—Ä–∞–±–ª—å! +30 –∑–æ–ª–æ—Ç–∞';
                } else if (r < 0.6) {
                    player.crew -= 8;
                    event = '–®—Ç–æ—Ä–º! -8 –¥—Ä—É–∂–∏–Ω—ã';
                }
            }
            
            if (event) addLog(event);
            
            if (player.crew <= 0) {
                addLog('üíÄ –¢–≤–æ—è –¥—Ä—É–∂–∏–Ω–∞ –ø–æ–≥–∏–±–ª–∞...');
            }
        }

        function rest() {
            player.power += 20;
            if (player.power > 100) player.power = 100;
            player.food -= 10;
            player.day++;
            addLog('–û—Ç–¥—ã—Ö +20 —Å–∏–ª—ã, -10 –µ–¥—ã');
            updateAll();
        }

        function hunt() {
            if (map[player.y][player.x] === 'üå≤') {
                if (Math.random() < 0.7) {
                    player.food += 30;
                    addLog('–£–¥–∞—á–Ω–∞—è –æ—Ö–æ—Ç–∞! +30 –µ–¥—ã');
                } else {
                    player.crew -= 2;
                    addLog('–û—Ö–æ—Ç–∞ –ø—Ä–æ–≤–∞–ª–∏–ª–∞—Å—å, –ø–æ—Ç–µ—Ä–∏ -2');
                }
            } else {
                addLog('–ó–¥–µ—Å—å –Ω–µ –Ω–∞ –∫–æ–≥–æ –æ—Ö–æ—Ç–∏—Ç—å—Å—è');
            }
            player.day++;
            updateAll();
        }

        function trade() {
            let cell = map[player.y][player.x];
            if (cell === 'üè°' || cell === 'üè∞') {
                if (player.gold >= 50) {
                    player.gold -= 50;
                    player.food += 40;
                    player.power += 15;
                    player.inventory.weapons += 2;
                    player.day++;
                    addLog('–¢–æ—Ä–≥–æ–≤–ª—è: -50 –∑–æ–ª–æ—Ç–∞, +40 –µ–¥—ã, +15 —Å–∏–ª—ã, +2 –æ—Ä—É–∂–∏—è');
                } else {
                    addLog('–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –∑–æ–ª–æ—Ç–∞');
                }
            } else {
                addLog('–ó–¥–µ—Å—å –Ω–µ —Å –∫–µ–º —Ç–æ—Ä–≥–æ–≤–∞—Ç—å');
            }
            updateAll();
        }

        function updateAll() {
            renderMap();
            updateStats();
        }

        // –ó–∞–ø—É—Å–∫
        loadGame();
        renderMap();
        updateStats();
        addLog('–°–∞–≥–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è...');
    </script>
</body>
</html>